name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Setup Rust (for Cargo.lock generation)
        uses: dtolnay/rust-toolchain@stable

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          semantic_version: 23
          extra_plugins: |
            @semantic-release/changelog@6
            @semantic-release/git@10
            @semantic-release/github@10
            @semantic-release/exec@6
            conventional-changelog-conventionalcommits@7

      - name: Debug outputs
        run: |
          echo "new_release_published: ${{ steps.semantic.outputs.new_release_published }}"
          echo "new_release_version: ${{ steps.semantic.outputs.new_release_version }}"

  build-macos:
    name: Build macOS (DMG)
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin # Apple Silicon
          - x86_64-apple-darwin # Intel
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}
        env:
          RUSTFLAGS: >
            ${{ matrix.target == 'aarch64-apple-darwin' && '-C target-cpu=apple-m1' || '-C target-cpu=x86-64-v3' }}

      - name: Create macOS App Bundle
        run: |
          APP_NAME="WiFi Bruteforce"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          TARGET="${{ matrix.target }}"
          APP_DIR="${APP_NAME}.app"

          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"

          # Copy binary to a different name (the actual executable)
          cp "target/${TARGET}/release/bruteforce-wifi" "${APP_DIR}/Contents/MacOS/${APP_NAME}_bin"
          chmod +x "${APP_DIR}/Contents/MacOS/${APP_NAME}_bin"

          # Create a launcher script that requests root privileges
          cat > "${APP_DIR}/Contents/MacOS/${APP_NAME}" << LAUNCHER_EOF
          #!/bin/bash
          # Launcher script that requests root privileges

          # Get the directory where this script is located
          SCRIPT_DIR="\$( cd "\$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
          BINARY="\${SCRIPT_DIR}/${APP_NAME}_bin"

          # Get the app bundle path (parent of Contents)
          APP_PATH="\$(dirname "\$(dirname "\${SCRIPT_DIR}")")"

          # Remove quarantine attributes if present (needed for unsigned apps)
          if [ "\$EUID" -eq 0 ]; then
              # Running as root, remove quarantine attributes
              xattr -cr "\${APP_PATH}" 2>/dev/null || true
          fi

          # Check if running as root
          if [ "\$EUID" -ne 0 ]; then
              # Not running as root, re-launch with sudo
              echo "This application requires root privileges to perform WiFi network operations."
              sudo "\$BINARY" "\$@"
              exit \$?
          else
              # Already running as root
              exec "\$BINARY" "\$@"
          fi
          LAUNCHER_EOF

          # Make the launcher executable
          chmod +x "${APP_DIR}/Contents/MacOS/${APP_NAME}"

          # Create Info.plist
          cat > "${APP_DIR}/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>${APP_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>com.maxgfr.bruteforce-wifi</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSLocationUsageDescription</key>
              <string>WiFi Bruteforce needs location access to retrieve WiFi BSSID information for network scanning.</string>
              <key>NSLocationWhenInUseUsageDescription</key>
              <string>WiFi Bruteforce needs location access to retrieve WiFi BSSID information for network scanning.</string>
              <key>LSUIElement</key>
              <false/>
              <key>LSRequiresRoot</key>
              <true/>
              <key>SMPrivilegedExecutables</key>
              <dict>
                  <key>com.maxgfr.bruteforce-wifi.helper</key>
                  <string>anchor apple generic and identifier "com.maxgfr.bruteforce-wifi.helper"</string>
              </dict>
          </dict>
          </plist>
          EOF

      - name: Sign the app bundle using apple-code-sign-action
        uses: indygreg/apple-code-sign-action@v1
        with:
          input_path: "WiFi Bruteforce.app"
          output_path: "WiFi Bruteforce.app"

      - name: Create DMG
        run: |
          APP_NAME="WiFi Bruteforce"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'arm64' || 'x86_64' }}"
          DMG_NAME="WiFi-Bruteforce-${VERSION}-macOS-${ARCH}.dmg"
          DMG_TEMP="dmg_temp"

          mkdir -p "${DMG_TEMP}"
          cp -R "${APP_NAME}.app" "${DMG_TEMP}/"
          ln -s /Applications "${DMG_TEMP}/Applications"

          hdiutil create -volname "${APP_NAME}" \
            -srcfolder "${DMG_TEMP}" \
            -ov \
            -format UDZO \
            -imagekey zlib-level=9 \
            "${DMG_NAME}"

          rm -rf "${DMG_TEMP}"

      - name: Generate SHA256
        run: |
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'arm64' || 'x86_64' }}"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          DMG_NAME="WiFi-Bruteforce-${VERSION}-macOS-${ARCH}.dmg"
          shasum -a 256 "${DMG_NAME}" > "${DMG_NAME}.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            WiFi-Bruteforce-*.dmg
            WiFi-Bruteforce-*.sha256

  build-windows:
    name: Build Windows (EXE)
    needs: release
    # if: needs.release.outputs.new_release_published == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install WinPcap SDK
        run: |
          Invoke-WebRequest -Uri "https://www.winpcap.org/install/bin/WpdPack_4_1_2.zip" -OutFile "WpdPack.zip"
          Expand-Archive -Path "WpdPack.zip" -DestinationPath "C:\"
          echo "LIB=C:\WpdPack\Lib\x64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build release binary
        run: cargo build --release
        env:
          RUSTFLAGS: "-C target-cpu=x86-64-v3"

      - name: Create installer with WiX
        run: |
          $VERSION = "${{ needs.release.outputs.new_release_version }}"
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "0.0.0-dev.${{ github.run_number }}" }
          $INSTALLER_NAME = "WiFi-Bruteforce-${VERSION}-Windows-x64.msi"

          # Simple ZIP for now (can be enhanced with WiX later)
          Compress-Archive -Path "target\release\bruteforce-wifi.exe" -DestinationPath "WiFi-Bruteforce-${VERSION}-Windows-x64.zip"

      - name: Generate SHA256
        run: |
          $VERSION = "${{ needs.release.outputs.new_release_version }}"
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "0.0.0-dev.${{ github.run_number }}" }
          $FILE = "WiFi-Bruteforce-${VERSION}-Windows-x64.zip"
          Get-FileHash -Algorithm SHA256 -Path $FILE | ForEach-Object { "$($_.Hash.ToLower())  $FILE" } | Out-File -FilePath "${FILE}.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            WiFi-Bruteforce-*.zip
            WiFi-Bruteforce-*.sha256

  build-linux:
    name: Build Linux
    needs: release
    # if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev libxkbcommon-dev libwayland-dev libgtk-3-dev

      - name: Build release binary
        run: cargo build --release

      - name: Create Archive
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          ARCHIVE_NAME="WiFi-Bruteforce-${VERSION}-Linux-x86_64.tar.gz"

          mkdir -p release_dist
          cp target/release/bruteforce-wifi release_dist/

          tar -czf "$ARCHIVE_NAME" -C release_dist .

      - name: Generate SHA256
        run: |
          FILE=$(ls WiFi-Bruteforce-*-Linux-*.tar.gz | head -n 1)
          shasum -a 256 "$FILE" > "$FILE.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            WiFi-Bruteforce-*-Linux-*.tar.gz
            WiFi-Bruteforce-*-Linux-*.sha256
